# ADR-001: Asymmetric Overlay System and LLM Role

Date: 2025-08-19
Status: Accepted

## Context
Fractured Truths relies on asymmetric information to create tension and deduction. We must:
- Maintain a canonical, deterministic world state for rules resolution and fairness
- Present different narratives per player, influenced by alignment and role
- Keep costs and complexity manageable in the MVP while leaving room for growth

Key questions:
- How do we represent player-specific knowledge overlays relative to the canonical state?
- Which persistence model best fits the MVP: Postgres tables, event sourcing, or in-memory only?
- Where does the LLM fit: authoritative state generator or narrative overlay?

## Decision

1) Asymmetric overlays layered on canonical state
- Canonical world lives in server memory and Postgres snapshots (`world_states`, `entities`, `factions`) and events (`events`).
- Player-specific overlays (`player_views`) are derived artifacts containing redactions, rumors, and narrative text. Overlays reference or summarize canonical facts but do not override them.
- The UI renders overlays; actions always resolve against canonical rules.

2) Postgres schema over pure event sourcing or in-memory only
- Postgres with normalized rows and JSONB columns (flexible schema) is chosen for MVP: operational simplicity, SQL debuggability, and durability.
- Event records are stored in `events` for replayability and audit, but we do not mandate full event-sourced rehydration in MVP.
- In-memory-only is insufficient for stability across restarts and multi-instance scenarios; we still use in-memory for hot state, but Postgres remains the source of truth.

3) LLM as narrative overlay, not ground truth
- The LLM is bounded to generate narrative overlays and asymmetric hints. It cannot directly mutate canonical state.
- All state transitions pass a deterministic rules engine; LLM outputs are schema-validated and treated as presentation/information artifacts.
- This preserves fairness, testability, and cost control, and prevents drift/contradictions from LLM hallucinations becoming canonical.

## Consequences

Positive:
- Deterministic gameplay with reproducible tests (rules engine unit tests).
- Clear separation of concerns: state vs. storytelling, enabling parallel iteration.
- Postgres enables simple queries, indices, and ops familiarity; JSONB supports evolving content.
- Cost control: prompt budgets apply only to overlays; reuse canonical logic without LLM calls.

Negative / trade-offs:
- Dual models (canonical + per-player overlays) require sync discipline and validation.
- Additional storage/compute for overlays per turn/player.
- Some narrative ambitions must be translated into deterministic effects via rules.

Follow-ups:
- Define schema indices on `(session_id, player_id, turn_index)` for `player_views` and `(session_id, turn_index)` for `world_states`.
- Introduce caching for stable overlay prompts and a replay report that compares overlays vs. canonical truth.
- Consider evolving toward event-sourced rehydration post-MVP if replay/persistence depth is prioritized.


